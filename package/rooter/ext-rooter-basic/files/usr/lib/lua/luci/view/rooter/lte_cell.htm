<%+header%>

<style>
	table, th, td {
	  border-collapse: collapse;
	  text-align: center;
	}

	table {
	  width: 100%;
	}
</style>

<script type="text/javascript" src="<%=resource%>/xhr.js"></script>
<script type="text/javascript">//<![CDATA[
		
	function startScan(btn)
	{
		// Change button state while scanning
		btn.disabled = true;
		btn.value    = '<%:Scanning...%>';
		// Start scanning
		XHR.get('<%=luci.dispatcher.build_url("admin", "modem", "lte_scancell")%>',
			null,
			function(x, rv)
			{
				const data = rv.log;
				const dataArr = data.split('\n');
				const table = document.getElementById('table-data');
				const tableHeader = `<tr>
						<th>TYPE </th>
						<th>OPERATOR </th>
						<th>COUNTRY </th>
						<th>PROTOCOL </th>
						<th>SCHEME </th>
						<th>MCC </th>
						<th>MNC </th>
						<th>CID </th>
						<th>PCID </th>
						<th>EARFCN </th>
						<th>FREQ BAND IND </th>
						<th>UL BW </th>
						<th>DL BW </th>
						<th>TAC </th>
						<th>RSRP </th>
						<th>RSRQ </th>
						<th>RSSI </th>
						<th>SINR </th>
						<th>SRXLEV </th>
						<th>CELL RSP </th>
						<th>SNIS </th>
						<th>SIS </th>
						<th>TXL </th>
						<th>TXH </th>
						<th></th>
					</tr>`;
			
				const tableBody = dataArr
				.filter(tr=>tr)
				.map((tr,index) => {
					const onlineArr = tr.split(' ');
					let onlineStr = onlineArr.map(td => `<td>${td}</td>`).join('\t');
					if(index > 0)
					{
						onlineStr = onlineStr + `<td><button class="cbi-button cbi-button-apply" style="padding: 0.1rem 0.3rem" onclick='lockCell(${index},this)' >Lock cell</button></td>`
					}
					return `<tr id='tr-${index}' >${onlineStr}</tr>`
				})
				.join('\n');
				table.innerHTML = tableHeader + tableBody;
				// re-init button
				btn.disabled = false;
				btn.value = '<%:Scan cell%>';
			}
		);
		return false;
	}

	function lockCell(index,btn) {
		// Change button state while locking
		btn.disabled  = true;
		btn.innerHTML = '<%:Locking...%>';

		// Parse PCID & EARFCN
		const id = `tr-${index}`;
		const tr = document.getElementById(id);
		const rowData = tr.querySelectorAll("td");
		const PCID = rowData[8].innerHTML;
		const EARFCN = rowData[9].innerHTML;
		console.log(PCID, EARFCN)

		// Request lock cell to back-end
		XHR.get('<%=luci.dispatcher.build_url("admin", "modem", "lte_lockcell")%>',
			{ PCID:PCID , EARFCN:EARFCN},
			function(x, rv)
			{
			}
		);
		
		// re-init button
		btn.innerHTML = '<%:Locked%>';
	}
//]]></script>
<div class="cbi-map" id="cbi-modem">
<h2><a id="content" name="content"><%:Modem Scan Cell Information%></a></h2>
<div class="cbi-map-descr"> </div>
<fieldset class="cbi-section" id="cbi-mod">
	<div align="left"> 
		<input type="button" class="cbi-button cbi-button-apply" value="<%:Scan cell%>" onclick="return startScan(this)" />
	</div>
	</table>
	<legend><%:Log Data%></legend>
	<table id="table-data"></table>
</fieldset>
<br></br>
</div>

<%+footer%>